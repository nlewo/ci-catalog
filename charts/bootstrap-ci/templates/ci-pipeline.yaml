apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  annotations:
    kapp.k14s.io/change-rule: "upsert after upserting tekton.dev/pipelines"
  name: ci-stage1
  namespace: tekton-pipelines
spec:
  inputs:
    params:
      - name: event
        type: string
      - name: repoName
        type: string
        description: Repository name
      - name: repoBranch
        type: string
        description: Repository branch
  steps:
    - name: create-pipeline-ns
      image: nixery.dev/shell/kubectl/yq/jq
      command: ["bash"]
      args:
        - "-ec"
        - |
          export NAMESPACE=pipeline-$(inputs.params.repoName)-$(inputs.params.repoBranch)
          echo "# Creating namespace $NAMESPACE"
          kubectl create namespace $NAMESPACE || true
          kubectl create rolebinding serviceaccounts-edit \
            --clusterrole=edit \
            --group=system:serviceaccounts:$NAMESPACE \
            --namespace=$NAMESPACE || true
          echo "# Fetching secrets from secrets-$(inputs.params.repoName) namespace"
          kubectl get -o json secrets -n secrets-$(inputs.params.repoName) | jq -s '.[].items | map(select(.kind == "Secret") | {"\(.metadata.name)": .data}) | add | {secrets: .}' > secrets.json
          echo '$(inputs.params.event)' > event.json
          cat event.json secrets.json | jq -s 'add | . * {namespace: env.NAMESPACE}' > trigger.json
    - name: trigger-pipeline
      image: nixery.dev/curl
      command: ["curl"]
      args:
        - -v
        - -H
        - "Content-Type: application/json"
        - -d
        - "@trigger.json"
        - http://el-internal-tekton-ci:8080
---
apiVersion: tekton.dev/v1alpha1
kind: ClusterTask
metadata:
  annotations:
    kapp.k14s.io/change-rule: "upsert after upserting tekton.dev/pipelines"
  name: ci-stage2
  namespace: tekton-pipelines
spec:
  inputs:
    params:
      - name: event
        type: string
      - name: namespace
        type: string
    resources:
      - name: project-repo
        type: git
  steps:
    - name: template-user-pipeline
      image: nixery.dev/shell/yq/coreutils/kubernetes-helm
      command: ["bash"]
      workingDir: /workspace/project-repo/.tekton
      args:
        - "-ec"
        - |
          export RUN_ID=$(cat /dev/urandom | tr -dc 'a-z0-9' | fold -w 5 | head -n1)
          echo '$(inputs.params.event)' | yq -y '{global: {ci: .}} * {global: {ci: {uid: env.RUN_ID}}}' > values-global.yaml
          echo "# CI template values:"
          cat values-global.yaml
          echo "# Rendered template:"
          helm template . --values=values-global.yaml > rendered.yaml
          cat rendered.yaml
    - name: deploy-user-pipeline
      image: eonpatapon/kapp
      command: ["kapp"]
      workingDir: /workspace/project-repo/.tekton
      args:
        - deploy
        - -n
        - $(inputs.params.namespace)
        - -a
        - $(inputs.params.namespace)
        - -f
        - rendered.yaml
        - -y
