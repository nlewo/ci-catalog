apiVersion: tekton.dev/v1alpha1
kind: EventListener
metadata:
  annotations:
    kapp.k14s.io/change-rule: "upsert after upserting tekton.dev/triggers"
    kapp.k14s.io/change-rule: "upsert after upserting tekton.dev/ci-eventlistener"
  name: external-tekton-ci
  namespace: tekton-pipelines
spec:
  serviceAccountName: tekton-ci-admin
  triggers:
    - name: ci-trigger
      binding:
        name: github-triggerbinding
      template:
        name: ci-template-stage1
      interceptor:
        header:
          - name: X-Push-Branches-Only
            value: "master"
        objectRef:
          apiVersion: v1
          kind: Service
          name: tekton-github-interceptor
          namespace: tekton-pipelines
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: el-ci-ingress
  namespace: tekton-pipelines
  annotations:
    kubernetes.io/ingress.class: nginx
spec:
  rules:
    - host: {{ .Values.github.webhookHost }}
      http:
        paths:
          - path: /
            backend:
              serviceName: el-external-tekton-ci
              servicePort: 8080
---
apiVersion: tekton.dev/v1alpha1
kind: EventListener
metadata:
  annotations:
    kapp.k14s.io/change-rule: "upsert after upserting tekton.dev/triggers"
    kapp.k14s.io/change-rule: "upsert after upserting tekton.dev/ci-eventlistener"
  name: internal-tekton-ci
  namespace: tekton-pipelines
spec:
  serviceAccountName: tekton-ci-admin
  triggers:
    - name: ci-trigger
      binding:
        name: internal-triggerbinding
      template:
        name: ci-template-stage2
